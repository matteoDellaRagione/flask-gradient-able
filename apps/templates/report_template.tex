\documentclass{article}
\usepackage[a4paper, margin=1in]{geometry} 
\usepackage{hyperref}
\usepackage{breakurl}
\usepackage{xurl}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{pgf-pie}
\usepackage{float}
\usepackage{booktabs}
\usepackage{longtable} % Per tabelle che si estendono su più pagine
\usepackage{array}     % Per allineamento avanzato delle colonne
\usepackage{tabularx}  % Per tabelle che si adattano alla larghezza della pagina
\usepackage{caption}
\usepackage{colortbl} % Per colorare le righe della tabella
\usepackage{morewrites}
\usepackage{etex}



% Configura la distanza tra tabella e didascalia
\captionsetup{belowskip=12pt} % Imposta uno spazio di 12pt sotto la tabella

\definecolor{darkgreen}{rgb}{0.0, 0.5, 0.0} % Verde più scuro
\definecolor{darkviolet}{rgb}{0.58, 0.0, 0.83} % Viola più intenso
\definecolor{lightred}{rgb}{1.0, 0.8, 0.8}
\definecolor{lightyellow}{rgb}{1.0, 1.0, 0.8}
\definecolor{lightgreen}{rgb}{0.8, 1.0, 0.8}


\title{Report for Domain: {{ domain }}}
\author{Generated by Apollo}
\date{\today}

\begin{document}

\maketitle
\clearpage

\tableofcontents  % Generates the table of contents

\clearpage

\section{Summary of Findings}

Below are some key statistics from the data provided:

\begin{itemize}
    \item \textbf{Number of IPs}: {{ json1.numIP }}
    \item \textbf{Number of Domains}: {{ json1.numDomini }}
    \item \textbf{Number of Emails}: {{ json1.numEmail }}
    \item \textbf{Number of Resolved Hosts}: {{ json1.numResolvedHosts }}
    \item \textbf{Number of Mail Servers}: {{ json1.numServerMail }}
    \item \textbf{Number of URLs}: {{ json1.numUrls }}
\end{itemize}

\clearpage

\section{IP Addresses found}

Below is the list of IP addresses found:


\begin{itemize}
    {% if json1.IP %}
        {% for ip in json1.IP %}
            \item {{ ip }}
        {% endfor %}
    {% else %}
    \item No IPs found
    {% endif %}
\end{itemize}

\clearpage

\section{Domain found}

Below is the list of Domain found:

\begin{itemize}
    {% if json1.domini %}
        {% for domain in json1.domini %}
            \item {{ domain }}
        {% endfor %}
    {% else %}
        \item No Domains found
    {% endif %}
\end{itemize}

\clearpage


\section{URLs found}

Below is the list of URLs found:
\begin{itemize}
    {% if json1.interesting_urls %}
        {% for url in json1.interesting_urls %}
            {% set url_parts = url.split('/')[2] %}
            \item \href{ {{ url }} }{ {{ url_parts }} }
        {% endfor %}
    {% else %}
        \item No URLs found
    {% endif %}
\end{itemize}

\clearpage

\section{Domain Related to URLs Found}

{% if json1.domain_urls %}
    {% for domain, urls in json1.domain_urls.items() %}
    \subsection{Domain: {{ domain }}}
    \begin{itemize}
        {% if urls %}
            {% for url in urls %}
                {% set url_parts = url.split('/')[2] %}
                \item \href{ {{ url }}}{ {{ url_parts }} }
            {% endfor %}
        {% else %}
            \item No URLs found
        {% endif %}
    \end{itemize}
{% endfor %}
{% else %}
\begin{itemize}
    \item No Domains or URLs found
\end{itemize}
{% endif %}

\clearpage

\section{Emails found}

Below is the list of Emails found:

\begin{itemize}
    {% if json1.emails %}
        {% for email in json1.emails %}
            \item {{ email }}
        {% endfor %}
    {% else %}
        \item No Emails found
    {% endif %}
\end{itemize}

\clearpage

\section{Resolved Hosts}

Below is a list of resolved hosts with their corresponding IP addresses:

\begin{itemize}
    {% if json1.resolved_hosts %}
        {% for host, ip in json1.resolved_hosts.items() %}
            \item \textbf{ {{ host }} }: {{ ip }}
        {% endfor %}
    {% else %}
        \item No Resolved Hosts found
    {% endif %}
\end{itemize}

\clearpage

\section{Server Mail found}

Below is the list of Mail Server found:

\begin{itemize}
    {% if json1['server mail'] %}
        {% for server_mail in json1['server mail'] %}
            \item {{ server_mail }}
        {% endfor %}
    {% else %}
        \item No Mail Server found
    {% endif %}
\end{itemize}

\clearpage

\section{Pie Chart of Vulnerabilities}

\noindent Pie chart showing the distribution of vulnerabilities for the domain \ttfamily {{ domain | safe }}:

{% if json2.total_critical_vulns > 0 or json2.total_high_vulns > 0 or json2.total_medium_vulns > 0 or json2.total_low_vulns > 0 %}
\begin{figure}[H]
    \centering
    \begin{tikzpicture}
        \pie[
            color={darkviolet, red, yellow, darkgreen},
            text=legend,
            radius=3,
            sum={{ json2.total_vulns }}
        ]
        {
            {{ json2.total_critical_vulns }}/Critical,
            {{ json2.total_high_vulns }}/High,
            {{ json2.total_medium_vulns }}/Medium,
            {{ json2.total_low_vulns }}/Low
        }
    \end{tikzpicture}
\end{figure}
{% else %}
\noindent \textbf{No vulnerabilities were found, so the pie chart is not displayed.}
{% endif %}

\clearpage

\section{Vulnerability Summary per IP}

\noindent The table below shows the number of critical, high, medium, and low vulnerabilities for each IP, ordered by the number of vulnerabilities (first by critical, then high, medium, and low):

\begin{longtable}{|>{\raggedright\arraybackslash}p{3cm}|c|c|c|c|}
    \hline
    \textbf{IP Address} & \textbf{Critical} & \textbf{High} & \textbf{Medium} & \textbf{Low} \\
    \hline
    \endfirsthead
    \hline
    \textbf{IP Address} & \textbf{Critical} & \textbf{High} & \textbf{Medium} & \textbf{Low} \\
    \hline
    \endhead
    \hline
    \endfoot
    \endlastfoot
    {% set sorted_results = json2.results | sort(attribute='lowVulns', reverse=True) | sort(attribute='mediumVulns', reverse=True) | sort(attribute='highVulns', reverse=True) | sort(attribute='criticalVulns', reverse=True) %}
    {% for result in sorted_results %}
    {% if result.criticalVulns > 0 or result.highVulns > 0 %}
    \rowcolor{lightred} % Righe con critical o high evidenziate in rosso
    {% elif result.mediumVulns > 0 or result.lowVulns > 0 %}
    \rowcolor{lightyellow} % Righe con medium o low evidenziate in giallo
    {% else %}
    \rowcolor{lightgreen} % Righe senza vulnerabilità evidenziate in verde
    {% endif %}
    {{ result.ip }} & {{ result.criticalVulns }} & {{ result.highVulns }} & {{ result.mediumVulns }} & {{ result.lowVulns }} \\
    \hline
    {% endfor %}
    \caption{Number of vulnerabilities per IP, sorted by severity.} \\
\end{longtable}

\clearpage

\section{Shodan Results for IP Addresses}

Below is the detailed report of vulnerabilities and services for each IP address:

{% set sorted_results = json2.results|sort(attribute='lowVulns', reverse=True)|sort(attribute='mediumVulns', reverse=True)|sort(attribute='highVulns', reverse=True)|sort(attribute='criticalVulns', reverse=True) %}


{% for result in sorted_results %}

\subsection{IP Address: {{ result.ip }}}

\begin{itemize}
    \item \textbf{Organization}: {{ result.organization }}
    \item \textbf{Operating System}: {% if result.os %} {{ result.os }} {% else %} N/A {% endif %}
    \item \textbf{Critical Vulnerabilities}: {{ result.criticalVulns }}
    \item \textbf{High Vulnerabilities}: {{ result.highVulns }}
    \item \textbf{Medium Vulnerabilities}: {{ result.mediumVulns }}
    \item \textbf{Low Vulnerabilities}: {{ result.lowVulns }}
    \item \textbf{Total Vulnerabilities}: {{ result.totalVulns }}
\end{itemize}

\subsubsection*{Services Running on IP Address}

\begin{itemize}
    {% for service in result.services %}
        \item \textbf{Service}: {{ service.service }}
        \begin{itemize}
            \item \textbf{Port}: {{ service.port }}
            \item \textbf{Version}: {% if service.version %} {{ service.version }} {% else %} N/A {% endif %}
            \item \textbf{Location}: \href{ {{ service.location }} }{ {{ service.location }} }
        \end{itemize}
    {% endfor %}
\end{itemize}

{% if result.vulnerabilities %}
\subsubsection*{Vulnerabilities Found}

\begin{itemize}
    {% for vuln in result.vulnerabilities %}
        \item \textbf{Vulnerability}: {{ vuln.vulnerability }}
        \begin{itemize}
            \item \textbf{CVSS Score}: {% if vuln.cvss %} {{ vuln.cvss }} {% else %} N/A {% endif %}
            \item \textbf{Description}:
            \parbox[t]{0.9\linewidth}{
                \ttfamily {{ vuln.description | safe }}
            }
        \end{itemize}
    {% endfor %}
\end{itemize}
{% else %}
\textbf{No vulnerabilities found for this IP address.}
{% endif %}



\clearpage

{% endfor %}

\end{document}
